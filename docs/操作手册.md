# A股自选股智能分析系统 - 操作手册

## 🚀 核心指令速查

  请在项目根目录下（`e:\project\daily_stock_analysis`）运行命令。

### 1. 一键启动（推荐）
使用项目提供的脚本，自动完成前端构建并启动后端：
```powershell
.\start.bat
```
- **访问地址**: [http://127.0.0.1:8000](http://127.0.0.1:8000)

### 2. 使用 uv 管理 Python 环境（推荐）
如果你使用 `uv`：
```powershell
# 首次安装依赖
uv sync

# 启动 Web 服务
uv run python main.py --webui-only

# 执行一次完整分析
uv run python main.py
```

### 3. 使用项目 venv 启动（兼容方式）
```powershell
.\.venv\Scripts\python main.py --webui-only
```

---

## 🧭 WebUI 主要功能入口

### 1) 助手配置（Agent）
- 路由：`/agents`
- 可配置：名称、描述、Base Prompt、手动工具、技能组合
- 支持技能预览：组合后的 system prompt、工具列表、预估 tokens

### 2) 技能库（Skill Library）
- 路由：`/skills`
- 支持：分类筛选、技能详情、用户技能 CRUD、模板应用到 Agent

### 3) 对话页（Chat）
- 路由：`/chat`
- 可选择 Agent 对话，验证技能组合后工具是否生效

---

## 🔧 常见问题与故障排查

### 🔴 问题一：Web 界面无法显示 (只显示 JSON)
**现象**：访问 `http://127.0.0.1:8000` 时，只看到 `{"message": "API ..."}`，没有图形界面。
**原因**：前端静态资源未构建，或后台进程卡死。

**✅ 解决方案**：
1. 直接使用 `start.bat`（会自动构建前端）
   ```powershell
   .\start.bat
   ```
2. 若仍异常，清理占用进程后重启：
   ```powershell
   taskkill /F /IM python.exe
   .\start.bat
   ```

---

### 🔴 问题二：提示 `ModuleNotFoundError`
**现象**：运行命令时提示找不到模块（例如 `No module named 'dotenv'`）。
**原因**：未使用项目环境执行。

**✅ 解决方案（uv）**：
```powershell
uv sync
uv run python main.py --webui-only
```

**✅ 解决方案（venv）**：
```powershell
.\.venv\Scripts\python main.py --webui-only
```

---

### 🔴 问题三：配置页“获取模型”失败，提示 SSL EOF
**现象**：`POST /api/v1/system/config/fetch-models` 返回失败，日志包含
`[SSL: UNEXPECTED_EOF_WHILE_READING]`。

**原因（常见）**：
- 代理链路 TLS 不稳定（系统代理/公司代理）
- `OPENAI_BASE_URL` 填写格式不规范
- API 网关仅支持特定路径（`/v1/models` 或 `/models`）

**✅ 已内置改进（当前版本）**：
- 自动尝试多种模型列表路径：`/v1/models` 与 `/models`
- 自动尝试 `trust_env=True/False`（分别走/不走系统代理）
- 网络异常返回更清晰提示（400）

**✅ 建议排查**：
1. Base URL 建议填 API 根地址，例如：
   - `https://api.deepseek.com`
   - `https://dashscope.aliyuncs.com/compatible-mode`
2. 检查系统代理变量：`HTTP_PROXY` / `HTTPS_PROXY`
3. 若在公司网络，尝试切换网络或关闭拦截代理后重试

---

## 🛠️ 新增：专家会诊功能 (v2.0)

多模型决策支持，降低单模型误判风险。

### 1. 专家会诊 (`/expert-panel`)
进入 WebUI 后，点击左侧会诊中心，即可针对特定股票发起多模型分析。系统将展示各模型的**独立评分**、**观点对比**并生成**自动汇总报告**。

### 2. 混合配置层
支持从数据库加载配置，方便在不重启服务的情况下修改 API Key 或股票列表。
- 设置环境变量 `CONFIG_STORAGE_TYPE=db` 开启该模式。

---

## 📁 核心文件说明
- `main.py`: 主程序入口。
- `start.bat`: 一键启动脚本（构建前端 + 启动后端）。
- `.env`: 配置文件 (包含 API Key 和股票列表)。
- `logs/`: 存放运行日志，报错时可以看这里。
- `data/`: 存放生成的分析报告和数据库。
